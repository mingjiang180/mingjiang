name: Test Docker-in-Docker (Build & Push)

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼Œé¿å…è‡ªåŠ¨è·‘
  # push:
  #   branches: [ main ]

jobs:
  build-and-push:
    runs-on: [self-hosted, team-a, ci]  # â† æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ runner æ ‡ç­¾

    env:
      # å¯é€‰ï¼šå¦‚æœä½ è¿˜æ²¡ç”¨ wrapper/aliasï¼Œä¸´æ—¶ç”¨å‘½ä»¤è¡Œå‚æ•°
      # DOCKER_BUILD_CMD: docker --tlscacert=""
      # ä½†æ¨èå·²åœ¨å®¹å™¨ä¸­ä¿®å¤ï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç”¨ docker

    steps:
      - name: ğŸ§ª Check Docker Connectivity
        run: |
          echo "Testing Docker daemon..."
          docker version
          echo "Docker info:"
          docker info --format 'Containers: {{.Containers}}, Images: {{.Images}}'

      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ³ Create Simple Dockerfile (if not exists)
        run: |
          cat > Dockerfile <<EOF
FROM alpine:latest
RUN echo "Hello from DinD!" > /hello.txt
CMD cat /hello.txt
EOF

      - name: ğŸ”¢ Generate Image Tag
        id: meta
        run: |
          IMAGE_NAME=your-registry.example.com/your-project/test-dind
          TAG=${GITHUB_SHA::8}
          echo "IMAGE=$IMAGE_NAME:$TAG" >> "$GITHUB_OUTPUT"
          echo "FULL_IMAGE=$IMAGE_NAME:$TAG" >> "$GITHUB_ENV"

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          docker build -t ${{ steps.meta.outputs.IMAGE }} .

      - name: ğŸ” Verify Image Exists
        run: |
          docker images | grep test-dind

      - name: ğŸ”‘ Login to Registry (optional)
        if: ${{ false }}  # â† é»˜è®¤è·³è¿‡ pushï¼Œå…ˆæµ‹è¯• build
        # å¦‚æœä½ è¦æµ‹è¯• pushï¼Œè¯·å–æ¶ˆæ³¨é‡Šä»¥ä¸‹å†…å®¹å¹¶é…ç½® secrets
        # uses: docker/login-action@v3
        # with:
        #   registry: your-registry.example.com
        #   username: ${{ secrets.REGISTRY_USERNAME }}
        #   password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: ğŸš€ Push Image (optional)
        if: ${{ false }}  # â† é»˜è®¤è·³è¿‡
        # run: docker push ${{ steps.meta.outputs.IMAGE }}

      - name: ğŸ§¹ Cleanup (optional but recommended)
        if: always()
        run: |
          docker system prune -af
